.. _troubleshooting:

*********************************
C. Решение проблем и рекомендации
*********************************

.. _problems-and-solutions:

С.1. Проблемы в работе сервиса PVR и их решения
===============================================

Дубликаты записей каналов
-------------------------

**Проблема:** в ходе эксплуатации MicroPVR записи некоторых каналов дублируются, в папке "ch_<id>" параллельно
записываются два или более ts-файла.

Такая проблема могла возникнуть из-за порчи записей в SQLite БД сервиса MicroPVR в следствие ошибки или других факторов.

**Возможные решения:**

* Для исправления ошибки необходимо остановить запись канала путем отключения записи в Smarty или с помощью утилиты
  micropvr_control. После этого убедиться, что запись остановилась, и соответствующие процессы recorder были
  остановлены. Затем включить запись повторно. Оставшиеся файлы-дубликаты будут удалены автоматически.

Увеличение времени запуска передач из архива и торможения при перемотке
-----------------------------------------------------------------------

**Проблема:** время включения передач из архива стало дольше обычного, попытки перемотки иногда подвисают, а иногда
срабатывают с задержкой.

**Возможные причины и решения:**

* Проверьте и освободите свободное место на диске, при критически малом объеме свободного пространства при использовании SSD
  системой может быть запущен процесс индексации kswapd, который существенно затормаживает работу I/O.
* Торможение может вызывать фоновый менеджер RAID-контроллера, либо утилита mdadm, выполняющая проверку целостности
  хранилища либо его восстановление.
* Из-за ошибок старых версий MicroPVR размер SQLite БД индексов и записей в /etc/micropvr/ мог стать очень большим,
  что может привести к замедлению поиска позиций в записанных файлах.
  Необходимо обновить ПО, сбросить БД и перезапустить задачи записи.
* Ошибки в работе сетевого контроллера, а также потери пакетов могут приводить к обрыву TCP-сессий к серверу PVR.
  Необходимо обновить драйвер сетевой карты, либо заменить её, а также устранить потери TCP-пакетов на всех участках сети.

Пропуски видео и обрывы трансляции при просмотре передач
--------------------------------------------------------

**Проблема:** при просмотре трансляции возникают кратковременные остановки и переходы на следующий участок эфира, а иногда
трансляция сбрасывается.

**Возможные причины и решения:**

* Сетевой контроллер не справляется с нагрузкой или работает некорректно. Необходимо заменить сетевую карту или обновить
  драйвер.

* Записываемый входящий Multicast-поток часто обрывается. Необходимо стабилизировать подачу видео-потоков.

На записанных передачах встречаются артефакты
---------------------------------------------

**Возможные причины и решения:**

* К артефактам в записях могут приводить потери пакетов на сети. Необходимо стабилизировать подачу видео-потоков.
* К артефактам может приводить некорректная работа сетевого контроллера. Необходимо заменить сетевую карту или обновить
  драйвер. В частности, известна проблема с чипом Intel 82674L при работе в режиме порта 1000 Mbit/sec - возникает
  "затормаживание" пакетов в очереди, что приводит к ошибкам (источник: https://communities.intel.com/message/144936).
* К потерям UDP-пакетов в ОС Ubuntu может приводить служба irqbalance, необходимо остановить её, выполнив:
  *service irqbalance stop*
* Из-за высокой нагрузки на CPU могут возникать потери пакетов. В этом случае может помочь распределение прерываний
  очередей сетевых карт по ядрам процессора, см. скрипт set_irq_affinity.sh https://gist.github.com/syuu1228/4352382.

Воспроизведение записей не включается
-------------------------------------

**Возможные причины и решения:**

* Проверьте запущенность всех компонентов системы: nginx с модулем pvs (/etc/init.d/micropvs), micropvr.


.. _recommendations:

C.2. Рекомендации
=================

.. _sysctl.conf:

Рекомендуемые параметры ядра
----------------------------

Изменения нужно вносить в файл /etc/sysctl.conf: ::

    kernel.shmmax = 2473822720
    kernel.shmall = 4097152000
    net.core.rmem_default = 8388608
    net.core.rmem_max = 16777216
    net.core.wmem_default = 8388608
    net.core.wmem_max = 16777216
    net.ipv4.tcp_syncookies = 1
    net.ipv4.tcp_tw_recycle = 0
    net.ipv4.tcp_tw_reuse = 0
    net.ipv4.tcp_keepalive_time = 10
    net.ipv4.tcp_fin_timeout = 5

Затем выполнить команду для применения изменений: ::

    sysctl -p

.. _limits.conf:

Дополнительные настройки ОС при очень большом количестве одновременных подключений
----------------------------------------------------------------------------------

В файле ``/etc/security/limits.conf`` необходимо прописать: ::

    *               soft    nofile          16384
    *               hard    nofile          16384


Рекомендуемый тип файловой системы и опции монтирования для хранилища HDD
-------------------------------------------------------------------------

Для обеспечения максимального быстродействия хранилища рекомендуется использовать XFS со следующими опциями: ::

  mkfs.xfs -f -d su=512k -d sw=<sw> -l su=256k /dev/<device>

где:

- sw - количество дисков в RAID-массиве
- device - название устройства, например sdc1

Опции монтирования в /etc/fstab: ::

  /dev/<device> <mountpoint> xfs async,noatime,nodiratime,attr2,nobarrier,logbufs=8,logbsize=256k,osyncisdsync 0 0

где:

- device - название устройства, например sdc1
- mountpoint - точка монтирования, например /opt/storage

Для SSD хранилища необходимо также добавить опции *discard,relatime*.
