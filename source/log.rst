.. _log:

**************
4. Логирование
**************

.. _micropvr_log:

4.1. Основной лог-файл процесса micropvr
========================================

**micropvr.log** - основной файл лога. Сообщения имеют вид: ::

  %timestamp% %log level% %module% %function% [%PID%] (%message code%) %message text%
  
Пример: ::

  Tue Mar 14 06:31:21 2017 DEBUG RECORDS MANAGER CheckWritingFilesSizes[18527]: file size check: ch_id-76_time-1489462267_task_id-962839 - 0 bytes
  
Возможные уровни сообщений в порядке увеличения детализированности лога (каждый следующий уровень включает в себя предыдущие уровни):

- CRITICAL - критические ошибки, влияющие непосредственно на работу процесса MicroPVR: ошибки копирования процесса, записи в БД и прочее.
- ERROR - значительные ошибки: ошибки чтения конфигурации, сообщения о нехватке места и др.
- WARNING - предупреждения: ошибки вызова API, сообщения о перезапуске задачи из-за ошибки и др.
- INFO - информационные сообщения.
- DEBUG - малозначительные сообщения, полезные для отладки.
- EXTENDED - обращения к базе данных.

Список некоторых возможных сообщений приведён в разделе :ref:`Список возможных кодов и сообщений лога micropvr <micropvr_log_doc_list>`.

.. _state_log:

4.2. Лог состояния micropvr
===========================

Если параметр **log-state-period** больше 0, то micropvr с заданной в минутах периодичностью будет вести лог состояния **micropvr_state.log**.

Вид записей лога: ::

  Log OK: 12/10 13:28:59
  Mem used: 958868 KiB, mem free: 3099672 KiB
  Swap used: 127652 KiB, swap free: 8257880 KiB
  CPU LA1: 0.5
  Content requests: 0 requests in 59 seconds, 0.0 per second
  Successful requests: 0 requests in 59 seconds, 0.0 per second

  ____________________________________________________________________________________________________________________________________________________
  | CID   | CHANNEL NAME  | SOURCE                | START TIME     | STOP TIME      | LOCK TIME      | REPEAT     | LOCATION      | PRIOR | STATUS    |
  ----------------------------------------------------------------------------------------------------------------------------------------------------
  | 1     | channel1      | udp://@239.1.2.3:1234 | 12/10 15:00:00 | 12/10 16:00:00 | 13/10 16:00:00 | 3600 secs  | /tmp/pvr/ch_1 | 3     | NEW       |
  | 2     | channel2      | udp://@239.1.2.3:1235 | 12/10 15:00:00 | 12/10 16:00:00 | 13/10 16:00:00 | 3600 secs  | /tmp/pvr/ch_2 | 3     | NEW       |
  | 3     | channel3      | udp://@239.1.2.3:1236 | 12/10 13:00:00 | 12/10 14:00:00 | 14/10 14:00:00 | 3600 secs  | /tmp/pvr/ch_3 | 3     | STARTED   |
  | 3     | channel3-ssd  | udp://@239.1.2.3:1236 | 12/10 13:00:00 | 12/10 14:00:00 | 14/10 14:00:00 | 3600 secs  | /ssd/pvr/ch_3 | 5     | STARTED   |
  | 4     | channel4      | udp://@239.1.2.3:1236 | 12/10 13:29:10 | 12/10 14:00:00 | 14/10 14:00:00 | 3600 secs  | /ssd/pvr/ch_4 | 5     | POSTPONED |
  | 5     | channel5      | udp://@239.1.2.3:1240 | 12/10 14:20:00 | 12/10 17:20:00 | 15/10 17:20:00 | no repeat  | /ssd/pvr/ch_5 | 5     | NEW       |
  ________________________________________________________________________________
  | PATH                          | FREE SPACE    | RESERVED      | AVAILABLE     |
  --------------------------------------------------------------------------------
  | /                             | 393849 MiB    | 30000 MiB     | 363849 MiB    |
  | /ssd                          | 128350 MiB    | 30000 MiB     | 98350 MiB     |
  
Поля таблицы задач:
  
- CID - идентификатор канала, заданный при создании задачи.
- CHANNEL NAME - имя канала, заданное при создании задачи.
- SOURCE - источник записи.
- START TIME - фактическое время начала записи (в часовом поясе сервера).
- STOP TIME - время окончания записи (в часовом поясе сервера).
- LOCK TIME - время, до которого блокируется автоматическое удаление записи (в часовом поясе сервера).
- REPEAT - период повторения задачи, может не совпадать с реальной длительностью записи.
  Если уже была создана новая задача, указывается ``repeated``, а если задача непериодическая, то указывается ``no repeat``.
- LOCATION - директория записи.
- PRIOR - приоритет записи. При запросе смещения и файла будет отдана запись с большим приоритетом.
- STATUS - статус задачи.

Возможные статусы:
  
- NEW - задача ещё не запущена и находится в списке ожидания.
- POSTPONED - аналогичен NEW, но задача была перезапущена вследствие ошибки.
- STARTING - задача находится в процессе запуска.
- FAILED - ошибка выполнения задачи.
- STARTED - задача находится в процессе выполнения, запись осуществляется.
- UNKNOWN - другой статус.

.. _recorder_log:

4.3. Лог recorder
=================

**recorder.log** - дополнительный лог-файл процессов recorder. Активируется опцией **recorder-log-enabled** в конфигурации MicroPVR. Сообщения имеют вид: ::

  %timestamp% %log level% %function% [%PID%] (%message code%) %message text%

Список некоторых возможных сообщений приведён в разделе :ref:`Список возможных кодов и сообщений лога recorder <recorder_log_doc_list>`.
